<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fresh Okanagan</title>
  <meta name="description" content="Fresh Okanagan">

    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <!-- iPhone ICON -->
    <link href="/img/apple-touch-icon-57x57.png" sizes="57x57" rel="apple-touch-icon-precomposed">
    <!-- iPad ICON-->
    <link href="/img/apple-touch-icon-72x72.png" sizes="72x72" rel="apple-touch-icon-precomposed">
    <!-- iPhone (Retina) ICON-->
    <link href="/img/apple-touch-icon-114x114.png" sizes="114x114" rel="apple-touch-icon-precomposed">
    <!-- iPad (Retina) ICON-->
    <link href="/img/apple-touch-icon-144x144.png" sizes="144x144" rel="apple-touch-icon-precomposed">

  <link rel=STYLESHEET href="css/normalize.css">
  <link rel=STYLESHEET href="css/foundation.min.css">
  <link rel=STYLESHEET href="css/style.css">
  <link rel=STYLESHEET href="css/app.css">

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="http://www.parsecdn.com/js/parse-1.2.2.min.js"></script>
  <script src="scripts/models.js"></script>
  <script src="scripts/api.js"></script>
  <script src="vendor/fastclick/fastclick.js"></script>
  <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvjmMxm6ATH92dAC_L60M13_u8AHbi2D8&sensor=false">
  </script>
</head>

<body>
  <div class="main-wrapper">
      <header class="header">
          <button class="small button show-filters"><span class="icon-magnifying-glass"></span></button>

          <button class="small button profile">Log In</button>
      </header>
      <div class="main">
          <section class="filters" role="complementary">
              <form class="search-box">
                  <span class="prefix icon-magnifying-glass"></span>
                  <input type="search">
                  <input type="submit" style="display: none">
              </form>
              <h3>Food types</h3>
              <label for="checkbox1" class="checkbox"><input type="checkbox" id="checkbox1"><span class="custom checkbox"></span> Meat</label>
              <label for="checkbox2" class="checkbox"><input type="checkbox" id="checkbox2"><span class="custom checkbox"></span> Vegetables</label>
              <label for="checkbox3" class="checkbox"><input type="checkbox" id="checkbox3"><span class="custom checkbox"></span> Fruits</label>
              <label for="checkbox4" class="checkbox"><input type="checkbox" id="checkbox4"><span class="custom checkbox"></span> Crafts</label>
              <label for="checkbox5" class="checkbox"><input type="checkbox" id="checkbox5"><span class="custom checkbox"></span> Miscellaneous</label>
          </section>
          <section class="map-area" role="map">
              <div id="map"></div>
              <button class="add-place"><span class="icon-map-pin-stroke"></span></button>
          </section>
      </div>

  </div>
  <div class="subsection">
      <div class="header">
          <button class="small button profile">Close</button>
      </div>
      <div class="relative">
          <form>
              <h3>Set up your food stand!</h3>
              <div class="profile__pic-wrap">
                  <img class="profile__pic" src="http://placekitten.com/300/300">
              </div>
              <div class="profile__name">
                  <p class="profile__fname">Myroslav</p>
                  <p class="profile__lname">Pomazan</p>
              </div>
              <ul class="button-group" style="clear: left;">
                  <li><a href="#" class="small button">Consumer</a></li>
                  <li><a href="#" class="small button">Producer</a></li>
              </ul>
              <p>
                  <label>Pictures</label>
                  <img src="http://placekitten.com/50/50">
                  <img src="http://placekitten.com/50/50">
                  <img src="http://placekitten.com/50/50">
                  <img src="http://placekitten.com/50/50">
              </p>
              <div>
                  <label>What are you selling?</label>
                  <textarea class="selling">Some description here</textarea>
              </div>
          </form>

      </div>
  </div>


  <script type="text/javascript">
    Parse.initialize("S8glxzOcLDwTgXQyfUZyg4Rm4znbNmBxzSbfHgpI", "LPS4XPWUjfIcNRgpfxoqbkWqybyW9Odfs205mwbn");

    (function() {

        $('.show-filters').on('click', function(e) {
            $('html').toggleClass('menu-open');
        });

        $('.profile').off('click').on('click', function(e) {
            if(!Parse.User.current() && $('.facebook-login').length === 0) {
                $('.subsection').append('<div class="facebook-login">' +
                        '<h1>Get. <span style="color: #5DA423">Fresh.</span> Now.</h1>' +
                        '<button class="uibutton confirm log-in">Log In with Facebook</button>' +
                        '</div>');
                $('.log-in').off('click').on('click', function(e) {
                    facebook.login(function(data) {

                        $('.facebook-login').remove();
                        $('.main-wrapper .profile').remove();
                        $('.main-wrapper > .header').append('<span class="profile"><img class="profile__pic small" src="'+data.img_url+'"></span>');
                        $('.subsection .profile').addClass('success').text('Save');
                        $('.profile__pic').attr('src', data.img_url);
                        $('.profile__fname').text(data.first_name);
                        $('.profile__lname').text(data.last_name);
                        $('.profile').off('click').on('click', function(e) {
                            if($(this).hasClass('success')){
                                console.log($('.selling').val()); // #DEV
                                api.save_user_data($('.selling').val());
                            }
                            $('html').toggleClass('sub-open');
                        });
                    });
                });
            }
            $('html').toggleClass('sub-open');
        });

        $('.log-in').on('click', function(e) {
            facebook.login(function(data) {
                    $('.facebook-login').remove();
                    $('.main-wrapper .profile').remove();
                    $('.main-wrapper > .header').append('<span class="profile"><img class="profile__pic small" src="'+data.img_url+'"></span>');
                    $('.subsection .profile').addClass('success').text('Save');
                    //$('.add-place').show();
                    $('.profile__pic').attr('src', data.img_url);
                    $('.profile__fname').text(data.first_name);
                    $('.profile__lname').text(data.last_name);
                });
            });



        var addMarkersOnTheMap = function(locations) {
            var infowindow = new google.maps.InfoWindow({});

            locations.forEach(function(location) {
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(location.get('lat'), location.get('long')),
                    animation: google.maps.Animation.DROP,
                    map: map
                });

                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent('<h5>'+ location.get('name') +'</h5>' +
                            '<p>'+ location.get('description') + '</p>');
                    infowindow.open(map, marker);
                });
            });
        };

        var mapOptions = {
            center: new google.maps.LatLng(49.883611, -119.493333),
            zoom: 12,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl: false,
            streetViewControl: false
        };

        var map = new google.maps.Map(document.getElementById("map"), mapOptions);

        col.MapLocation.fetch({
            success: function (data) {
                addMarkersOnTheMap(data);
            }
        });

        userMarker = new google.maps.Marker({
            title: "Your current location!",
            icon: 'img/car.png',
            animation: google.maps.Animation.DROP
        });

        $('.add-place').on('click', function(e) {
            if (!userMarker.getMap() && navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position){
                    var latitude = position.coords.latitude;
                    var longitude = position.coords.longitude;
                    var coords = new google.maps.LatLng(latitude, longitude);

                    var infowindow = new google.maps.InfoWindow({
                        content: '<h4>Here I am!</h4>'
                    });

                    userMarker.setPosition(coords);
                    userMarker.setMap(map);

                    google.maps.event.addListener(userMarker, 'click', function() {
                        infowindow.open(map, userMarker);
                    });
                });
            } else {
                userMarker.setMap(null);
            }
        });

        window.addEventListener('load', function() {
            new FastClick(document.body);
        }, false);


    })();
  </script>
  <script src="scripts/facebook_init.js"></script>

</body>

</html>
